---
name: Build DMP Cloud Core

parameters:
  - name: serviceConnectionName
    type: string
    default: ''
  - name: resource-location
    type: string
    default: 'eastus' 
  - name: dmpcloud-core-env-abbreviation
    type: string
    default: 'dev' 
  - name: dmpcloud-core-rg-tags
    type: object
    default: {
      "environment": "dev",
      "costCenter": "dmp",
      "project": "dmpcloud-core"
    }
  - name: dmpcloud-core-env-grafana-admins-principalids
    type: string
    #  Mounir EGA-GRAFANA-ADMINS
    default: '79b6f6c1-e8b6-4579-8877-f93db40f85d7 75d2910c-f7e6-4fbd-8665-8200d96e3be6'   
  - name: dmpcloud-core-env-grafana-admins-principaltypes
    type: string
    # Mounir EGA-GRAFANA-ADMINS
    default: ' User Group' 
  # Grab from KV
  - name: dmpcloud-core-subcon-applicationId
    type: string
    default:    
  - name: dmpcloud-core-env-grafana-admins-principaltypes
    type: string
    # Mecit Mounir Group
    default: 'User User Group'       


variables:
    # concatenate "dmpcloud-core-" with parameter dmpcloud-core-env-abbreviation and suffix with "-rg"
    #Resource Groups
  - name: dmpcloud-core-env-rgname
    value: replace('dmp-cloudcore-ENV-rg' , 'ENV', dmpcloud-core-env-abbreviation)
  - name: dmpcloud-core-env-arc-rgname
    value: replace('dmp-cloudcore-ENV-arc-rg' , 'ENV',dmpcloud-core-env-abbreviation)

    #Resources
  - name: dmpcloud-core-env-akv-name 
    value: replace('dmpcloudcoreENVakv' , 'ENV',dmpcloud-core-env-abbreviation)
  - name: dmpcloud-core-env-acr-name
    value: replace('dmpcloudcoreENVacr' , 'ENV',dmpcloud-core-env-abbreviation) 
  - name: dmpcloud-core-env-law-name 
    value: replace('dmpcloudcoreENVlaw' , 'ENV',dmpcloud-core-env-abbreviation) 
  - name: dmpcloud-core-env-monwks-name 
    value: replace('dmpcloudcoreENVmonwks' , 'ENV',dmpcloud-core-env-abbreviation) 
  - name: dmpcloud-core-env-grafana-name 
    value: replace('dmpcloudcoreENVgrafana' , 'ENV',dmpcloud-core-env-abbreviation) 
  - name: dmpcloud-core-env-grafana-name 
    value: replace('dmpcloudcoreENVgrafana' , 'ENV',dmpcloud-core-env-abbreviation) 
 

   


pool:
  vmImage: 'ubuntu-latest'

steps:
  - checkout: self


#dmpcloud-core-env-rgname [LogAnalytics, Monitor, ACR, Grafana]
#dmpcloud-core-env-arc-rgname [Arc for Kubernetes]
#dmpcloud-core-env-akv-name [KeyVault]

# Login to Azure
  - task: AzureCLI@2
    displayName: 'Azure Login'
    inputs:
      azureSubscription: 'mythicalDMPSubSPN'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        #!/bin/bash
        az account show


# Create resource group for dmpcloud-core-env-rgname
  - task: AzureCLI@2
    displayName: 'Create Resource Group for DMP Cloud Core'
    inputs:
      azureSubscription: 'mythicalDMPSubSPN'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        #!/bin/bash   
        # Create the main resource group
        #az group create --name $(dmpcloud-core-env-rgname) --location $(variables.resource-location)
        az group create --name 'HELLO_RG' --location 'EastUS'
        az tag create --resource-group ${{ variables.dmpcloud-core-env-rgname  }} --tags ${{ variables.resourcegroup-tags  }}
